  <!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµë¬´ì§€ì›ê³¼ AI ìƒë‹´ ì±—ë´‡</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans KR', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 1000px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 90vh;
      max-height: 900px;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px 30px;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .header-icon {
      font-size: 32px;
    }

    .header-content {
      flex: 1;
      min-width: 200px;
    }

    .header-content h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .header-content p {
      font-size: 13px;
      opacity: 0.9;
    }

    .header-badges {
      display: flex;
      gap: 8px;
    }

    .badge {
      padding: 5px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    .badge-ai {
      background: #10b981;
      color: white;
    }

    .badge-free {
      background: #fbbf24;
      color: #000;
    }

    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .sidebar {
      width: 280px;
      background: #f9fafb;
      border-right: 1px solid #e5e7eb;
      padding: 20px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .sidebar h3 {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .faq-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .faq-item {
      background: white;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      color: #374151;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .faq-item.loading {
      opacity: 0.5;
      pointer-events: none;
    }

    .faq-rank {
      background: #667eea;
      color: white;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      flex-shrink: 0;
    }

    .faq-text {
      flex: 1;
      line-height: 1.4;
    }

    .faq-item:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
      transform: translateY(-1px);
    }

    .faq-item:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(102, 126, 234, 0.15);
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .message {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .message.bot .avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .message.user .avatar {
      background: #f3f4f6;
    }

    .message-content {
      flex: 1;
      max-width: 70%;
    }

    .message.user .message-content {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .message-bubble {
      padding: 14px 18px;
      border-radius: 18px;
      line-height: 1.6;
      font-size: 14px;
    }

    .message.bot .message-bubble {
      background: #f3f4f6;
      color: #1f2937;
      border-bottom-left-radius: 4px;
    }

    .message.user .message-bubble {
      background: #667eea;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message-meta {
      display: flex;
      gap: 12px;
      margin-top: 8px;
      font-size: 11px;
      color: #9ca3af;
      align-items: center;
    }

    .confidence-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .confidence-high { background: #d1fae5; color: #065f46; }
    .confidence-medium { background: #fef3c7; color: #92400e; }
    .confidence-low { background: #fee2e2; color: #991b1b; }

    .sources {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    .sources-title {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .source-item {
      padding: 6px 10px;
      background: #f9fafb;
      border-radius: 6px;
      font-size: 12px;
      color: #374151;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .source-category {
      background: #667eea;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }

    .input-area {
      padding: 20px;
      background: #fafbfc;
      border-top: 1px solid #e5e7eb;
    }

    .input-container {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    #messageInput {
      flex: 1;
      padding: 14px 18px;
      border: 1px solid #d1d5db;
      border-radius: 12px;
      font-size: 14px;
      outline: none;
      transition: all 0.2s;
      resize: none;
      font-family: inherit;
      max-height: 120px;
    }

    #messageInput:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    #sendButton {
      padding: 14px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #sendButton:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    #sendButton:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
    }

    #sendButton:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 14px 18px;
      background: #f3f4f6;
      border-radius: 18px;
      border-bottom-left-radius: 4px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: #6b7280;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    .feedback-buttons {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .feedback-btn {
      padding: 6px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      color: #374151;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .feedback-btn:hover {
      border-color: #667eea;
      background: #f3f4ff;
      transform: translateY(-1px);
    }

    .feedback-btn:active {
      transform: translateY(0);
    }

    .feedback-btn.clicked {
      background: #667eea;
      color: white;
      pointer-events: none;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #1f2937;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .modal-btn.primary {
      background: #667eea;
      color: white;
    }

    .modal-btn.primary:hover {
      background: #5a67d8;
      transform: translateY(-1px);
    }

    .modal-btn.primary:active {
      transform: translateY(0);
    }

    .modal-btn.secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .modal-btn.secondary:hover {
      background: #e5e7eb;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
    }

    .form-input, .form-textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: all 0.2s;
    }

    .form-input:focus, .form-textarea:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .star-rating {
      display: flex;
      gap: 8px;
      margin: 10px 0;
    }

    .star {
      font-size: 24px;
      color: #d1d5db;
      cursor: pointer;
      transition: all 0.15s;
    }

    .star:hover {
      color: #fbbf24;
      transform: scale(1.1);
    }

    .star.active {
      color: #fbbf24;
    }

    .welcome-message {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .welcome-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .welcome-title {
      font-size: 20px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .welcome-text {
      font-size: 14px;
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      .container {
        height: 100vh;
        max-height: none;
        border-radius: 0;
      }

      .sidebar {
        display: none;
      }

      .message-content {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-icon">ğŸ“</div>
      <div class="header-content">
        <h1>êµë¬´ì§€ì›ê³¼ AI ìƒë‹´ ì±—ë´‡</h1>
        <p>êµì› ì¸ì‚¬ ë° í–‰ì • ì—…ë¬´ì— ëŒ€í•´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”</p>
      </div>
      <div class="header-badges">
        <span class="badge badge-ai">AI ì§€ì›</span>
        <span class="badge badge-free">Beta</span>
      </div>
    </div>

    <div class="main-content">
      <div class="sidebar">
        <h3>ğŸ“Œ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ TOP 5</h3>
        <div id="faqList" class="faq-list">
          <!-- FAQ í•­ëª©ë“¤ì´ ì—¬ê¸° ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
      </div>

      <div class="chat-area">
        <div id="chatMessages" class="chat-messages">
          <div class="welcome-message">
            <div class="welcome-icon">ğŸ¤–</div>
            <div class="welcome-title">ì•ˆë…•í•˜ì„¸ìš”! êµë¬´ì§€ì›ê³¼ AI ì±—ë´‡ì…ë‹ˆë‹¤</div>
            <div class="welcome-text">
              êµì› ì¸ì‚¬, ì¬ì„ìš©, íœ´ì§, ì—°êµ¬ë…„ ë“±<br>
              êµë¬´ ê´€ë ¨ ì—…ë¬´ì— ëŒ€í•´ ë„ì›€ì„ ë“œë¦½ë‹ˆë‹¤.<br>
              ì™¼ìª½ì˜ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ì„ í´ë¦­í•˜ê±°ë‚˜<br>
              ì•„ë˜ì— ì§ì ‘ ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
            </div>
          </div>
        </div>

        <div class="input-area">
          <div class="input-container">
            <textarea 
              id="messageInput" 
              placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (Shift+Enterë¡œ ì¤„ë°”ê¿ˆ)"
              rows="1"
            ></textarea>
            <button id="sendButton">
              <span>ì „ì†¡</span>
              <span>â¤</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- í”¼ë“œë°± ëª¨ë‹¬ -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ğŸ“ ë‹µë³€ í‰ê°€</div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ë‹µë³€ì´ ë„ì›€ì´ ë˜ì—ˆë‚˜ìš”? ë³„ì ì„ ë‚¨ê²¨ì£¼ì„¸ìš”:</label>
          <div class="star-rating">
            <span class="star" onclick="setRating(1)">â˜…</span>
            <span class="star" onclick="setRating(2)">â˜…</span>
            <span class="star" onclick="setRating(3)">â˜…</span>
            <span class="star" onclick="setRating(4)">â˜…</span>
            <span class="star" onclick="setRating(5)">â˜…</span>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ì¶”ê°€ ì˜ê²¬ (ì„ íƒì‚¬í•­):</label>
          <textarea id="feedbackComment" class="form-textarea" placeholder="ë” ë‚˜ì€ ì„œë¹„ìŠ¤ë¥¼ ìœ„í•´ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" onclick="closeFeedbackModal()">ì·¨ì†Œ</button>
        <button class="modal-btn primary" onclick="submitFeedback()">ì œì¶œ</button>
      </div>
    </div>
  </div>

  <!-- ì—ìŠ¤ì»¬ë ˆì´ì…˜ ëª¨ë‹¬ -->
  <div id="escalationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ğŸ‘¤ ë‹´ë‹¹ì ì—°ê²° ìš”ì²­</div>
      <div class="modal-body">
        <p style="margin-bottom: 20px; color: #6b7280;">
          ë‹´ë‹¹ìê°€ ì§ì ‘ ë‹µë³€í•´ë“œë¦´ ìˆ˜ ìˆë„ë¡<br>
          ì—°ë½ì²˜ ì •ë³´ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.
        </p>
        <div class="form-group">
          <label class="form-label">ì´ë©”ì¼ *</label>
          <input type="email" id="escalationEmail" class="form-input" placeholder="your@email.com" required>
        </div>
        <div class="form-group">
          <label class="form-label">ì „í™”ë²ˆí˜¸ (ì„ íƒ)</label>
          <input type="tel" id="escalationPhone" class="form-input" placeholder="010-1234-5678">
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" onclick="closeEscalationModal()">ì·¨ì†Œ</button>
        <button class="modal-btn primary" onclick="submitEscalation()">ìš”ì²­í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== ì„¤ì • ====================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzle0C6ZDUyKif7t-PO_vE3vViRj7l6It3Mi9_njIBFVnCYm1t1w-qHWCeVesXB_QJrcA/exec';
    const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    let isLoading = false;
    let pendingFeedback = null;
    let pendingEscalation = null;
    let currentRating = 0;

    // ==================== ì´ˆê¸°í™” ====================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ“ êµë¬´ì§€ì›ê³¼ AI ì±—ë´‡ ì´ˆê¸°í™”');
      console.log('ì„¸ì…˜ ID:', sessionId);
      
      loadFAQs();
      setupEventListeners();
    });

    // ==================== FAQ ë¡œë“œ ====================
    async function loadFAQs() {
      try {
        console.log('FAQ ë¡œë”© ì‹œì‘...');
        
        const faqList = document.getElementById('faqList');
        
        // ë¡œë”© í‘œì‹œ
        faqList.innerHTML = '<div style="text-align: center; color: #9ca3af;">FAQë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        
        const response = await fetch(SCRIPT_URL + '?action=getFAQ&limit=5', {
          method: 'GET',
          mode: 'cors'
        });
        
        const data = await response.json();
        console.log('FAQ ì‘ë‹µ:', data);
        
        if (data.success && data.faqs && Array.isArray(data.faqs)) {
          displayFAQs(data.faqs);
        } else {
          console.error('FAQ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜:', data);
          displayDefaultFAQs();
        }
        
      } catch (error) {
        console.error('FAQ ë¡œë“œ ì˜¤ë¥˜:', error);
        displayDefaultFAQs();
      }
    }

    // FAQ í‘œì‹œ
    function displayFAQs(faqs) {
      const faqList = document.getElementById('faqList');
      faqList.innerHTML = '';
      
      console.log('FAQ í‘œì‹œ:', faqs.length, 'ê°œ');
      
      faqs.forEach((faq, index) => {
        const item = document.createElement('div');
        item.className = 'faq-item';
        
        const rank = document.createElement('div');
        rank.className = 'faq-rank';
        rank.textContent = (index + 1).toString();
        
        const text = document.createElement('div');
        text.className = 'faq-text';
        text.textContent = faq.question || `ì§ˆë¬¸ ${index + 1}`;
        
        item.appendChild(rank);
        item.appendChild(text);
        
        // í´ë¦­ ì´ë²¤íŠ¸ - ì¦‰ê° í”¼ë“œë°±
        item.addEventListener('click', async function() {
          if (item.classList.contains('loading')) return;
          
          // ì¦‰ì‹œ ì‹œê°ì  í”¼ë“œë°±
          item.classList.add('loading');
          
          // ì§ˆë¬¸ ë³´ë‚´ê¸°
          await sendMessage(faq.question);
          
          // ë¡œë”© ìƒíƒœ í•´ì œ
          setTimeout(() => {
            item.classList.remove('loading');
          }, 500);
        });
        
        faqList.appendChild(item);
      });
    }

    // ê¸°ë³¸ FAQ í‘œì‹œ (API ì˜¤ë¥˜ ì‹œ)
    function displayDefaultFAQs() {
      const defaultFaqs = [
        { question: 'ì¬ì„ìš© ì‹¬ì‚¬ ê¸°ì¤€ì€ ë¬´ì—‡ì¸ê°€ìš”?' },
        { question: 'íœ´ì§ ì‹ ì²­ì€ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?' },
        { question: 'ì—°êµ¬ë…„ ì‹ ì²­ ìê²©ì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?' },
        { question: 'ìŠ¹ì§„ì„ìš© ì ˆì°¨ê°€ ê¶ê¸ˆí•©ë‹ˆë‹¤' },
        { question: 'ì¶œì¥ ë³µëª…ì„œëŠ” ì–¸ì œê¹Œì§€ ì œì¶œí•˜ë‚˜ìš”?' }
      ];
      
      displayFAQs(defaultFaqs);
    }

    // ==================== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ====================
    function setupEventListeners() {
      const messageInput = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      
      // ì „ì†¡ ë²„íŠ¼ í´ë¦­
      sendButton.addEventListener('click', handleSendClick);
      
      // Enter í‚¤ ì²˜ë¦¬
      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSendClick();
        }
      });
      
      // ìë™ ë†’ì´ ì¡°ì ˆ
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });
    }

    // ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
    async function handleSendClick() {
      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();
      
      if (message && !isLoading) {
        // ì¦‰ì‹œ ì…ë ¥ì°½ ë¹„ìš°ê³  ì „ì†¡
        messageInput.value = '';
        messageInput.style.height = 'auto';
        await sendMessage(message);
      }
    }

    // ==================== ë©”ì‹œì§€ ì „ì†¡ ====================
    async function sendMessage(message) {
      if (isLoading) return;
      
      isLoading = true;
      const sendButton = document.getElementById('sendButton');
      sendButton.disabled = true;
      sendButton.innerHTML = '<span>ì „ì†¡ ì¤‘...</span>';
      
      // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
      addMessage('user', message);
      
      // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì¶”ê°€
      const typingId = addTypingIndicator();
      
      try {
        const formData = new URLSearchParams();
        formData.append('action', 'chat');
        formData.append('sessionId', sessionId);
        formData.append('question', message);
        formData.append('userRole', 'faculty');
        
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData,
          mode: 'cors'
        });
        
        const data = await response.json();
        console.log('ì±—ë´‡ ì‘ë‹µ:', data);
        
        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì œê±°
        removeTypingIndicator(typingId);
        
        if (data.success) {
          addMessage('bot', data.answer, {
            sources: data.sources || [],
            confidence: data.confidence || 0.8,
            messageId: data.messageId
          });
        } else if (data.filtered) {
          addMessage('bot', data.error, { isError: true });
        } else {
          addMessage('bot', 'ì£„ì†¡í•©ë‹ˆë‹¤. ë‹µë³€ì„ ìƒì„±í•˜ëŠ”ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', { isError: true });
        }
        
      } catch (error) {
        console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
        removeTypingIndicator(typingId);
        addMessage('bot', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', { isError: true });
        
      } finally {
        isLoading = false;
        sendButton.disabled = false;
        sendButton.innerHTML = '<span>ì „ì†¡</span><span>â¤</span>';
      }
    }

    // ==================== ë©”ì‹œì§€ ì¶”ê°€ ====================
    function addMessage(sender, text, options = {}) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
      
      if (sender === 'user') {
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = 'ğŸ‘¤';
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.textContent = text;
        
        const meta = document.createElement('div');
        meta.className = 'message-meta';
        meta.innerHTML = `<span>${time}</span>`;
        
        messageContent.appendChild(bubble);
        messageContent.appendChild(meta);
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);
      } else {
        let confidenceBadge = '';
        let confidenceClass = '';
        
        if (options.confidence) {
          if (options.confidence >= 0.8) {
            confidenceClass = 'confidence-high';
            confidenceBadge = '<span class="confidence-badge ' + confidenceClass + '">âœ“ ì‹ ë¢°ë„ ë†’ìŒ</span>';
          } else if (options.confidence >= 0.6) {
            confidenceClass = 'confidence-medium';
            confidenceBadge = '<span class="confidence-badge ' + confidenceClass + '">â— ì‹ ë¢°ë„ ë³´í†µ</span>';
          } else {
            confidenceClass = 'confidence-low';
            confidenceBadge = '<span class="confidence-badge ' + confidenceClass + '">! ì‹ ë¢°ë„ ë‚®ìŒ</span>';
          }
        }
        
        let sourcesHtml = '';
        if (options.sources && options.sources.length > 0) {
          sourcesHtml = '<div class="sources"><div class="sources-title">ğŸ“š ì°¸ê³  ë¬¸ì„œ</div>';
          options.sources.forEach(source => {
            sourcesHtml += `
              <div class="source-item">
                <span class="source-category">${source.category || ''}</span>
                <span>${source.filename || ''}</span>
              </div>
            `;
          });
          sourcesHtml += '</div>';
        }
        
        let feedbackHtml = '';
        if (!options.isError && options.messageId) {
          feedbackHtml = `
            <div class="feedback-buttons">
              <button class="feedback-btn positive" data-message-id="${options.messageId}" data-feedback="positive">
                ğŸ‘ ë„ì›€ë¨
              </button>
              <button class="feedback-btn negative" data-message-id="${options.messageId}" data-feedback="negative">
                ğŸ‘ ë„ì›€ ì•ˆë¨
              </button>
              <button class="feedback-btn escalate" data-action="escalate">
                ğŸ‘¤ ë‹´ë‹¹ì ì—°ê²°
              </button>
            </div>
          `;
        }
        
        messageDiv.innerHTML = `
          <div class="avatar">ğŸ¤–</div>
          <div class="message-content">
            <div class="message-bubble">${escapeHtml(text).replace(/\n/g, '<br>')}</div>
            ${sourcesHtml}
            <div class="message-meta">
              <span>${time}</span>
              ${confidenceBadge}
            </div>
            ${feedbackHtml}
          </div>
        `;
      }
      
      chatMessages.appendChild(messageDiv);
      
      // í”¼ë“œë°± ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      if (!options.isError && options.messageId) {
        const positiveBtn = messageDiv.querySelector('.feedback-btn.positive');
        const negativeBtn = messageDiv.querySelector('.feedback-btn.negative');
        const escalateBtn = messageDiv.querySelector('.feedback-btn.escalate');
        
        if (positiveBtn) {
          positiveBtn.addEventListener('click', function() {
            // ì¦‰ì‹œ ì‹œê°ì  í”¼ë“œë°±
            this.classList.add('clicked');
            this.textContent = 'âœ“ ê°ì‚¬í•©ë‹ˆë‹¤!';
            giveFeedback(options.messageId, text, 'positive');
          });
        }
        
        if (negativeBtn) {
          negativeBtn.addEventListener('click', function() {
            // ì¦‰ì‹œ ì‹œê°ì  í”¼ë“œë°±
            this.classList.add('clicked');
            giveFeedback(options.messageId, text, 'negative');
          });
        }
        
        if (escalateBtn) {
          escalateBtn.addEventListener('click', function() {
            // ì¦‰ì‹œ ì‹œê°ì  í”¼ë“œë°±
            this.classList.add('clicked');
            requestEscalation(text);
          });
        }
      }
      
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°
    function addTypingIndicator() {
      const chatMessages = document.getElementById('chatMessages');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message bot';
      typingDiv.id = 'typing-indicator-' + Date.now();
      
      typingDiv.innerHTML = `
        <div class="avatar">ğŸ¤–</div>
        <div class="message-content">
          <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      `;
      
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      return typingDiv.id;
    }

    function removeTypingIndicator(id) {
      const indicator = document.getElementById(id);
      if (indicator) {
        indicator.remove();
      }
    }

    // ==================== í”¼ë“œë°± ====================
    function giveFeedback(messageId, question, feedback) {
      pendingFeedback = { messageId, question, feedback };
      currentRating = 0;
      
      // ë³„ì  ì´ˆê¸°í™”
      document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
      document.getElementById('feedbackComment').value = '';
      
      // ëª¨ë‹¬ ì—´ê¸°
      document.getElementById('feedbackModal').classList.add('active');
    }

    function setRating(rating) {
      currentRating = rating;
      const stars = document.querySelectorAll('.star');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.classList.add('active');
        } else {
          star.classList.remove('active');
        }
      });
    }

    async function submitFeedback() {
      if (!pendingFeedback) return;
      
      const comment = document.getElementById('feedbackComment').value.trim();
      
      try {
        const formData = new URLSearchParams();
        formData.append('action', 'feedback');
        formData.append('sessionId', sessionId);
        formData.append('messageId', pendingFeedback.messageId);
        formData.append('feedback', pendingFeedback.feedback);
        formData.append('rating', currentRating);
        if (comment) formData.append('comment', comment);
        
        await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData,
          mode: 'cors'
        });
        
        alert('í”¼ë“œë°±ì„ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ˜Š');
        closeFeedbackModal();
        
      } catch (error) {
        console.error('í”¼ë“œë°± ì „ì†¡ ì˜¤ë¥˜:', error);
        alert('í”¼ë“œë°± ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function closeFeedbackModal() {
      document.getElementById('feedbackModal').classList.remove('active');
      pendingFeedback = null;
      currentRating = 0;
    }

    // ==================== ì—ìŠ¤ì»¬ë ˆì´ì…˜ ====================
    function requestEscalation(question) {
      pendingEscalation = { question };
      document.getElementById('escalationEmail').value = '';
      document.getElementById('escalationPhone').value = '';
      document.getElementById('escalationModal').classList.add('active');
    }

    async function submitEscalation() {
      if (!pendingEscalation) return;
      
      const email = document.getElementById('escalationEmail').value.trim();
      const phone = document.getElementById('escalationPhone').value.trim();
      
      if (!email) {
        alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const formData = new URLSearchParams();
        formData.append('action', 'escalate');
        formData.append('sessionId', sessionId);
        formData.append('question', pendingEscalation.question);
        formData.append('userEmail', email);
        if (phone) formData.append('userPhone', phone);
        
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData,
          mode: 'cors'
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('ë‹´ë‹¹ì ì—°ê²° ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nê³§ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ğŸ˜Š');
          closeEscalationModal();
        } else {
          throw new Error(data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        }
        
      } catch (error) {
        console.error('ì—ìŠ¤ì»¬ë ˆì´ì…˜ ì˜¤ë¥˜:', error);
        alert('ìš”ì²­ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function closeEscalationModal() {
      document.getElementById('escalationModal').classList.remove('active');
      pendingEscalation = null;
    }

    // ==================== ìœ í‹¸ë¦¬í‹° ====================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.classList.remove('active');
      }
    };
  </script>
</body>
</html>
