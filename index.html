<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìš©ì¸ëŒ€í•™êµ êµë¬´ì§€ì›ê³¼ AI ì±—ë´‡</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans KR', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 1000px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 90vh;
      max-height: 900px;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px 30px;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .header-icon {
      font-size: 32px;
    }

    .header-content {
      flex: 1;
      min-width: 200px;
    }

    .header-content h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .header-content p {
      font-size: 13px;
      opacity: 0.9;
    }

    .header-badges {
      display: flex;
      gap: 8px;
    }

    .badge {
      padding: 5px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    .badge-ai {
      background: #10b981;
      color: white;
    }

    .badge-rag {
      background: #fbbf24;
      color: #000;
    }

    /* RAG ìƒíƒœ í‘œì‹œ */
    .rag-status {
      background: #f0f0f0;
      padding: 10px;
      text-align: center;
      font-size: 0.9em;
      color: #666;
      border-bottom: 1px solid #e5e7eb;
    }

    .rag-status.active {
      background: #d4edda;
      color: #155724;
    }

    .rag-status.inactive {
      background: #fff3cd;
      color: #856404;
    }

    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .sidebar {
      width: 280px;
      background: #f9fafb;
      border-right: 1px solid #e5e7eb;
      padding: 20px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .sidebar h3 {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .faq-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .faq-item {
      background: white;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      color: #374151;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .faq-rank {
      background: #667eea;
      color: white;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      flex-shrink: 0;
    }

    .faq-item:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
      transform: translateY(-1px);
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .message {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .message.bot .avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .message.user .avatar {
      background: #f3f4f6;
    }

    .message-content {
      flex: 1;
      max-width: 70%;
    }

    .message.user .message-content {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .message-bubble {
      padding: 14px 18px;
      border-radius: 18px;
      line-height: 1.6;
      font-size: 14px;
    }

    .message.bot .message-bubble {
      background: #f3f4f6;
      color: #1f2937;
      border-bottom-left-radius: 4px;
    }

    .message.user .message-bubble {
      background: #667eea;
      color: white;
      border-bottom-right-radius: 4px;
    }

    /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .markdown-content {
      word-wrap: break-word;
    }

    .markdown-content p {
      margin: 0 0 12px 0;
    }

    .markdown-content p:last-child {
      margin-bottom: 0;
    }

    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3 {
      margin: 16px 0 8px 0;
      font-weight: 600;
      line-height: 1.3;
    }

    .markdown-content h1 {
      font-size: 18px;
      color: #667eea;
    }

    .markdown-content h2 {
      font-size: 16px;
      color: #374151;
    }

    .markdown-content h3 {
      font-size: 15px;
      color: #4b5563;
    }

    .markdown-content strong {
      font-weight: 600;
      color: #1f2937;
    }

    .markdown-content em {
      font-style: italic;
    }

    .markdown-content code {
      background: #e5e7eb;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #dc2626;
    }

    .markdown-content pre {
      background: #1f2937;
      color: #f9fafb;
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 12px 0;
    }

    .markdown-content pre code {
      background: none;
      padding: 0;
      color: #f9fafb;
      font-size: 13px;
    }

    .markdown-content ul,
    .markdown-content ol {
      margin: 8px 0;
      padding-left: 24px;
    }

    .markdown-content li {
      margin: 4px 0;
      line-height: 1.6;
    }

    .markdown-content a {
      color: #667eea;
      text-decoration: none;
      border-bottom: 1px solid #667eea;
    }

    .markdown-content a:hover {
      color: #5568d3;
      border-bottom-color: #5568d3;
    }

    .message-meta {
      display: flex;
      gap: 12px;
      margin-top: 8px;
      font-size: 11px;
      color: #9ca3af;
      align-items: center;
    }

    .confidence-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .confidence-high { background: #d1fae5; color: #065f46; }
    .confidence-medium { background: #fef3c7; color: #92400e; }
    .confidence-low { background: #fee2e2; color: #991b1b; }

    .rag-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: #4CAF50;
      color: white;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .sources {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    .sources-title {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .source-item {
      padding: 6px 10px;
      background: #f9fafb;
      border-radius: 6px;
      font-size: 12px;
      color: #374151;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .source-category {
      background: #667eea;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }

    .feedback-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .feedback-btn {
      padding: 6px 12px;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .feedback-btn:hover {
      border-color: #667eea;
      background: #f3f4f6;
    }

    .feedback-btn.positive:hover { color: #10b981; border-color: #10b981; }
    .feedback-btn.negative:hover { color: #ef4444; border-color: #ef4444; }
    .feedback-btn.escalate { color: #f59e0b; }
    .feedback-btn.escalate:hover { border-color: #f59e0b; background: #fffbeb; }

    .chat-input-area {
      padding: 20px 25px;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .input-container {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
      padding-bottom: 20px;
    }

    #userInput {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
      resize: none;
      font-family: inherit;
      transition: all 0.2s;
      min-height: 50px;
      max-height: 120px;
    }

    #userInput:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    #sendBtn {
      padding: 14px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      white-space: nowrap;
    }

    #sendBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    #sendBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 14px 18px;
      background: #f3f4f6;
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      width: fit-content;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9ca3af;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #1f2937;
    }

    .rating-stars {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin: 20px 0;
    }

    .star {
      font-size: 32px;
      cursor: pointer;
      color: #d1d5db;
      transition: all 0.2s;
    }

    .star:hover,
    .star.active {
      color: #fbbf24;
      transform: scale(1.2);
    }

    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      min-height: 100px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .modal-btn-primary {
      background: #667eea;
      color: white;
    }

    .modal-btn-primary:hover {
      background: #5568d3;
    }

    .modal-btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .modal-btn-secondary:hover {
      background: #e5e7eb;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }

    .input-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .container {
        height: 100vh;
        max-height: none;
        border-radius: 0;
      }

      .main-content {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        max-height: 200px;
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
      }

      .message-content {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-icon">ğŸ“</div>
      <div class="header-content">
        <h1>ìš©ì¸ëŒ€í•™êµ êµë¬´ì§€ì›ê³¼ AI ì±—ë´‡</h1>
        <p>AI ê¸°ë°˜ RAG ê²€ìƒ‰ ë° ìƒë‹´ ì„œë¹„ìŠ¤ (v2.0 - RAG Integrated)</p>
      </div>
      <div class="header-badges">
        <span class="badge badge-ai">âœ¨ AI</span>
        <span class="badge badge-rag">ğŸ” RAG</span>
      </div>
    </div>

    <!-- RAG Status -->
    <div class="rag-status" id="ragStatus">
      RAG ì‹œìŠ¤í…œ í™•ì¸ ì¤‘...
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Sidebar: FAQ -->
      <div class="sidebar">
        <h3>
          <span>ğŸ’¡</span>
          ìì£¼ ë¬»ëŠ” ì§ˆë¬¸
        </h3>
        <div id="faqList" class="faq-list">
          <div style="color: #9ca3af; text-align: center; padding: 20px; font-size: 13px;">
            FAQ ë¡œë”© ì¤‘...
          </div>
        </div>
      </div>

      <!-- Chat Area -->
      <div class="chat-area">
        <div id="chatMessages" class="chat-messages">
          <!-- Welcome Message -->
          <div class="message bot">
            <div class="avatar">ğŸ¤–</div>
            <div class="message-content">
              <div class="message-bubble">
                ì•ˆë…•í•˜ì„¸ìš”! ìš©ì¸ëŒ€í•™êµ êµë¬´ì§€ì›ê³¼ AI ì±—ë´‡ì…ë‹ˆë‹¤. ğŸ˜Š<br><br>
                êµì› ì¸ì‚¬, ê·œì •, ì—…ë¬´ ì ˆì°¨ ë“±ì— ëŒ€í•´ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.<br>
                ì™¼ìª½ì˜ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ì„ í´ë¦­í•˜ê±°ë‚˜ ì§ì ‘ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </div>
            </div>
          </div>
        </div>

        <!-- Input Area -->
        <div class="chat-input-area">
          <div class="input-container">
            <div class="input-wrapper">
              <textarea
                id="userInput"
                placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (Enterë¡œ ì „ì†¡, Shift+Enterë¡œ ì¤„ë°”ê¿ˆ)"
                onkeypress="handleKeyPress(event)"
                oninput="updateCharCount()"
                maxlength="1000"
              ></textarea>
              <div id="charCount" style="position: absolute; bottom: 5px; right: 10px; font-size: 11px; color: #9ca3af;">
                0/1000
              </div>
            </div>
            <button id="sendBtn" onclick="sendMessage()">
              ì „ì†¡
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ë‹µë³€ì´ ë„ì›€ì´ ë˜ì…¨ë‚˜ìš”?</div>
      <div class="rating-stars" id="ratingStars">
        <span class="star" onclick="setRating(1)">â˜…</span>
        <span class="star" onclick="setRating(2)">â˜…</span>
        <span class="star" onclick="setRating(3)">â˜…</span>
        <span class="star" onclick="setRating(4)">â˜…</span>
        <span class="star" onclick="setRating(5)">â˜…</span>
      </div>
      <textarea id="feedbackComment" placeholder="ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­)"></textarea>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeFeedbackModal()">ì·¨ì†Œ</button>
        <button class="modal-btn modal-btn-primary" onclick="submitFeedback()">ì œì¶œ</button>
      </div>
    </div>
  </div>

  <!-- Escalation Modal -->
  <div id="escalationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ë‹´ë‹¹ì ì—°ê²° ìš”ì²­</div>
      <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
        ë‹´ë‹¹ìê°€ ì§ì ‘ ë‹µë³€ë“œë¦´ ìˆ˜ ìˆë„ë¡ ì—°ë½ì²˜ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.
      </p>
      <div class="input-group">
        <label>ì´ë©”ì¼</label>
        <input type="email" id="escalationEmail" placeholder="example@university.ac.kr">
      </div>
      <div class="input-group">
        <label>ì „í™”ë²ˆí˜¸ (ì„ íƒ)</label>
        <input type="tel" id="escalationPhone" placeholder="010-0000-0000">
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeEscalationModal()">ì·¨ì†Œ</button>
        <button class="modal-btn modal-btn-primary" onclick="submitEscalation()">ìš”ì²­í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== RAG ì„¤ì • ====================
    const RAG_API_URL = 'https://rag-api-424378449323.asia-northeast3.run.app';
    const USE_RAG = true;  // RAG ì‚¬ìš© ì—¬ë¶€

    // ==================== Apps Script ì„¤ì • ====================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyk10db91eD9EyqSmOURZgoqZfQKlBLCHYxI1P09i8TvHp7QaaCMeRb6iW_aXNFwZmQHg/exec';

    // API ì„¤ì •
    const API_CONFIG = {
      TIMEOUT_MS: 20000,  // Apps Script íƒ€ì„ì•„ì›ƒ 30ì´ˆ â†’ 20ì´ˆë¡œ ìµœì í™”
      RAG_TIMEOUT_MS: 3000,  // RAG íƒ€ì„ì•„ì›ƒ 3ì´ˆ
      RAG_MAX_RETRIES: 2,  // RAG ì¬ì‹œë„ 2ë²ˆ
      MAX_RETRIES: 3,
      RETRY_DELAY_MS: 1000,
      FAQ_LIMIT: 5,
      BUTTON_FEEDBACK_DELAY_MS: 1000
    };

    // ì…ë ¥ ê²€ì¦ ì„¤ì •
    const VALIDATION_CONFIG = {
      MAX_QUESTION_LENGTH: 1000,
      MIN_QUESTION_LENGTH: 2,
      MAX_COMMENT_LENGTH: 500
    };

    // ==================== ì „ì—­ ë³€ìˆ˜ ====================
    const sessionId = generateSessionId();
    let pendingFeedback = null;
    let pendingEscalation = null;
    let currentRating = 0;

    // ==================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ====================
    function generateSessionId() {
      return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function generateMessageId() {
      return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // ==================== RAG ìƒíƒœ í™•ì¸ ====================
    async function checkRAGStatus() {
      if (!USE_RAG) {
        updateRAGStatus('ì¼ë°˜ ëª¨ë“œ (RAG ë¹„í™œì„±í™”)', 'inactive');
        return;
      }

      try {
        // ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ìœ„í•œ ìˆ˜ë™ íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);

        const response = await fetch(`${RAG_API_URL}/health`, {
          method: 'GET',
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (response.ok) {
          const data = await response.json();
          updateRAGStatus(`RAG ì—°ê²°ë¨ (ë¬¸ì„œ ${data.vector_store_count || 0}ê°œ)`, 'active');
        } else {
          updateRAGStatus('RAG ì„œë²„ ì˜¤ë¥˜ - ì¼ë°˜ ëª¨ë“œë¡œ ì‘ë™', 'inactive');
        }
      } catch (error) {
        console.warn('RAG ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
        updateRAGStatus('RAG ì—°ê²° ì‹¤íŒ¨ - ì¼ë°˜ ëª¨ë“œë¡œ ì‘ë™', 'inactive');
      }
    }

    function updateRAGStatus(message, status) {
      const statusElement = document.getElementById('ragStatus');
      statusElement.textContent = message;
      statusElement.className = `rag-status ${status}`;
    }

    // RAG ì „ìš© ì¬ì‹œë„ ë¡œì§ì´ ìˆëŠ” fetch
    async function fetchRAGWithRetry(url, options = {}, maxRetries = API_CONFIG.RAG_MAX_RETRIES) {
      let lastError;

      for (let attempt = 0; attempt <= maxRetries; attempt++) {
        try {
          console.log(`RAG API ìš”ì²­ ì‹œë„ ${attempt + 1}/${maxRetries + 1}`);

          // ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ìœ„í•œ ìˆ˜ë™ íƒ€ì„ì•„ì›ƒ
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.RAG_TIMEOUT_MS);

          const response = await fetch(url, {
            ...options,
            signal: controller.signal
          });

          clearTimeout(timeoutId);

          if (response.ok) {
            return response;
          }

          // 4xx ì—ëŸ¬ëŠ” ì¬ì‹œë„í•˜ì§€ ì•ŠìŒ
          if (response.status >= 400 && response.status < 500) {
            throw new Error(`RAG API í´ë¼ì´ì–¸íŠ¸ ì˜¤ë¥˜: ${response.status}`);
          }

          lastError = new Error(`RAG API ì„œë²„ ì˜¤ë¥˜: ${response.status}`);

        } catch (error) {
          lastError = error;

          // ë§ˆì§€ë§‰ ì‹œë„ê°€ ì•„ë‹ˆë©´ ì¬ì‹œë„
          if (attempt < maxRetries) {
            const delay = API_CONFIG.RETRY_DELAY_MS * Math.pow(2, attempt);
            console.log(`${delay}ms í›„ RAG ì¬ì‹œë„...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }

      throw lastError || new Error('RAG API ì—°ê²° ì‹¤íŒ¨');
    }

    // íƒ€ì„ì•„ì›ƒ ê¸°ëŠ¥ì´ ìˆëŠ” fetch
    async function fetchWithTimeout(url, options = {}, timeout = API_CONFIG.TIMEOUT_MS) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);

      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        return response;
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('ìš”ì²­ ì‹œê°„ ì´ˆê³¼ (30ì´ˆ)');
        }
        throw error;
      }
    }

    // ì¬ì‹œë„ ë¡œì§ì´ ìˆëŠ” fetch
    async function fetchWithRetry(url, options = {}, maxRetries = API_CONFIG.MAX_RETRIES) {
      let lastError;

      for (let attempt = 0; attempt <= maxRetries; attempt++) {
        try {
          console.log(`API ìš”ì²­ ì‹œë„ ${attempt + 1}/${maxRetries + 1}`);
          const response = await fetchWithTimeout(url, options);

          if (response.ok) {
            return response;
          }

          if (response.status >= 400 && response.status < 500) {
            return response;
          }

          lastError = new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);

        } catch (error) {
          lastError = error;

          if (attempt < maxRetries) {
            const delay = API_CONFIG.RETRY_DELAY_MS * Math.pow(2, attempt);
            console.log(`${delay}ms í›„ ì¬ì‹œë„...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }

      throw lastError || new Error('ì•Œ ìˆ˜ ì—†ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
    }

    function showButtonFeedback(button, feedbackText, originalText) {
      button.innerHTML = feedbackText;
      button.disabled = true;
      button.style.opacity = '0.6';

      setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
        button.style.opacity = '1';
      }, API_CONFIG.BUTTON_FEEDBACK_DELAY_MS);
    }

    // ==================== í˜ì´ì§€ ë¡œë“œ ====================
    window.onload = function() {
      console.log('=== ì±—ë´‡ ì´ˆê¸°í™” ì‹œì‘ ===');
      console.log('SCRIPT_URL:', SCRIPT_URL ? 'ì„¤ì •ë¨' : 'ë¯¸ì„¤ì •');
      console.log('RAG_API_URL:', RAG_API_URL);
      console.log('USE_RAG:', USE_RAG);

      if (!SCRIPT_URL) {
        showError('âš ï¸ ì„¤ì • í•„ìš”\n\nSCRIPT_URL ë³€ìˆ˜ì— ë°°í¬ëœ Apps Script URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      } else {
        checkRAGStatus();
        loadFAQ();
        document.getElementById('userInput').focus();

        // 30ì´ˆë§ˆë‹¤ RAG ìƒíƒœ í™•ì¸
        setInterval(checkRAGStatus, 30000);
      }
    };

    function showError(message) {
      const faqList = document.getElementById('faqList');
      faqList.innerHTML = '<div style="color: #ef4444; background: #fee2e2; padding: 15px; border-radius: 8px; white-space: pre-line; font-size: 12px; line-height: 1.6;">' + message + '</div>';
    }

    // ==================== FAQ ë¡œë”© ====================
    async function loadFAQ() {
      const faqList = document.getElementById('faqList');

      // ì„ì‹œë¡œ ë¡œë”© í‘œì‹œ
      faqList.innerHTML = '<div style="text-align: center; padding: 20px; color: #667eea;">â³ FAQ ë¡œë”© ì¤‘...</div>';

      try {
        console.log('=== FAQ ë¡œë”© ì‹œì‘ ===');
        const url = `${SCRIPT_URL}?action=getFAQ&limit=${API_CONFIG.FAQ_LIMIT}`;
        console.log('ìš”ì²­ URL:', url);

        const response = await fetchWithRetry(url, {
          method: 'GET',
          mode: 'cors',
          cache: 'no-cache'
        });

        console.log('FAQ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

        if (!response.ok) {
          throw new Error('API ì‘ë‹µ ì˜¤ë¥˜: ' + response.status);
        }

        const data = await response.json();
        console.log('=== FAQ ì‘ë‹µ ë°ì´í„° ===');
        console.log('success:', data.success);
        console.log('faqs ê°œìˆ˜:', data.faqs?.length || 0);
        console.log('source:', data.source);
        console.log('message:', data.message);
        console.log('ì „ì²´ ë°ì´í„°:', data);

        if (data.success && data.faqs && data.faqs.length > 0) {
          faqList.innerHTML = '';

          // êµ¬ë²„ì „ Apps Script ê°ì§€ (questionì´ ìˆ«ìì¸ ê²½ìš°)
          const isOldVersion = typeof data.faqs[0].question === 'number' ||
                               data.faqs[0].question === '1' ||
                               !data.source;

          if (isOldVersion) {
            console.warn('âš ï¸ Apps Script êµ¬ë²„ì „ ê°ì§€! ì¬ë°°í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            console.warn('ì„ì‹œë¡œ ìƒ˜í”Œ FAQë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');

            // í”„ë¡ íŠ¸ì—”ë“œ ìƒ˜í”Œ FAQ ì‚¬ìš©
            data.faqs = [
              { question: 'ì¬ì„ìš© ì‹¬ì‚¬ ê¸°ì¤€ì€ ë¬´ì—‡ì¸ê°€ìš”?', category: 'ì¸ì‚¬' },
              { question: 'íœ´ì§ ì‹ ì²­ì€ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?', category: 'ì¸ì‚¬' },
              { question: 'ì—°êµ¬ë…„ ì‹ ì²­ ìê²©ì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?', category: 'ì—°êµ¬' },
              { question: 'ìŠ¹ì§„ì„ìš© ì ˆì°¨ê°€ ê¶ê¸ˆí•©ë‹ˆë‹¤', category: 'ì¸ì‚¬' },
              { question: 'ì¶œì¥ ë³µëª…ì„œëŠ” ì–¸ì œê¹Œì§€ ì œì¶œí•˜ë‚˜ìš”?', category: 'í–‰ì •' }
            ];
            data.source = 'frontend-fallback';
          }

          // ë°ì´í„° ì†ŒìŠ¤ í‘œì‹œ (ë””ë²„ê·¸ìš©)
          if (data.source === 'real-data') {
            console.log('âœ… ì‹¤ì œ ì§ˆë¬¸ ë¹ˆë„ ê¸°ë°˜ Top 5 í‘œì‹œ');
          } else if (data.source === 'faq-sheet') {
            console.log('ğŸ“‹ FAQ ì‹œíŠ¸ì—ì„œ ë¡œë“œ');
          } else if (data.source === 'frontend-fallback') {
            console.log('ğŸ”„ í”„ë¡ íŠ¸ì—”ë“œ Fallback FAQ ì‚¬ìš© (Apps Script ì¬ë°°í¬ í•„ìš”)');
          } else if (data.message) {
            console.log('âš ï¸ ' + data.message);
          }

          data.faqs.forEach((faq, index) => {
            const question = faq.question || faq.title || faq.q || '';

            if (!question) {
              console.warn('FAQ í•­ëª© #' + index + 'ì— ì§ˆë¬¸ì´ ì—†ìŒ:', faq);
              return;
            }

            console.log('FAQ #' + (index + 1) + ':', question);

            const faqDiv = document.createElement('div');
            faqDiv.className = 'faq-item';

            const rankDiv = document.createElement('div');
            rankDiv.className = 'faq-rank';
            rankDiv.textContent = String(index + 1);

            const questionDiv = document.createElement('div');
            questionDiv.style.flex = '1';

            // ì§ˆë¬¸ íšŸìˆ˜ í‘œì‹œ (ì‹¤ì œ ë°ì´í„°ì¸ ê²½ìš°)
            if (faq.count && faq.count > 1) {
              questionDiv.innerHTML = `${question} <span style="color: #667eea; font-size: 11px; font-weight: 600;">(${faq.count}íšŒ)</span>`;
            } else {
              questionDiv.textContent = question;
            }

            faqDiv.appendChild(rankDiv);
            faqDiv.appendChild(questionDiv);

            faqDiv.addEventListener('click', function() {
              console.log('FAQ í´ë¦­:', question);
              askFAQ(question);
            });

            faqList.appendChild(faqDiv);
          });

          console.log('âœ… FAQ ' + data.faqs.length + 'ê°œ ë Œë”ë§ ì™„ë£Œ');

        } else {
          console.warn('FAQ ë°ì´í„° ì—†ìŒ ë˜ëŠ” ì‹¤íŒ¨:', data);
          const debugInfo = data.debug ? `<br><small style="color: #999;">ë””ë²„ê·¸: ${data.debug}</small>` : '';
          const messageInfo = data.message ? `<br><small>${data.message}</small>` : '';
          faqList.innerHTML = `<div style="color: #999; text-align: center; padding: 20px; font-size: 13px;">ë“±ë¡ëœ FAQê°€ ì—†ìŠµë‹ˆë‹¤.${messageInfo}${debugInfo}</div>`;
        }

      } catch (error) {
        console.error('âŒ FAQ ë¡œë“œ ì˜¤ë¥˜:', error);
        console.error('ì˜¤ë¥˜ ìƒì„¸:', error.message);
        console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);

        let errorMsg = 'âš ï¸ FAQë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';

        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorMsg += '<br><br>ğŸ“Œ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜<br><small>â€¢ CORS ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>â€¢ Apps Script ë°°í¬ ìƒíƒœ í™•ì¸<br>â€¢ "ëª¨ë“  ì‚¬ìš©ì" ì•¡ì„¸ìŠ¤ ê¶Œí•œ í™•ì¸</small>';
        } else if (error.message.includes('timeout') || error.message.includes('abort')) {
          errorMsg += '<br><br>â±ï¸ ì‹œê°„ ì´ˆê³¼<br><small>Apps Script ì‘ë‹µì´ ë„ˆë¬´ ëŠë¦½ë‹ˆë‹¤</small>';
        } else {
          errorMsg += '<br><br>ì˜¤ë¥˜: ' + error.message;
        }

        errorMsg += '<br><br><button onclick="loadFAQ()" style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">ğŸ”„ ë‹¤ì‹œ ì‹œë„</button>';

        faqList.innerHTML = '<div style="color: #ef4444; text-align: center; padding: 15px; line-height: 1.6; font-size: 12px;">' + errorMsg + '</div>';
      }
    }

    function askFAQ(question) {
      document.getElementById('userInput').value = question;
      sendMessage();
    }

    // ==================== ë©”ì‹œì§€ ì „ì†¡ (RAG í†µí•©) ====================
    async function sendMessage() {
      const input = document.getElementById('userInput');
      const question = input.value.trim();

      // ì…ë ¥ ê²€ì¦
      if (!question) return;

      if (question.length < VALIDATION_CONFIG.MIN_QUESTION_LENGTH) {
        alert(`ì§ˆë¬¸ì€ ìµœì†Œ ${VALIDATION_CONFIG.MIN_QUESTION_LENGTH}ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
        return;
      }

      if (question.length > VALIDATION_CONFIG.MAX_QUESTION_LENGTH) {
        alert(`ì§ˆë¬¸ì€ ìµœëŒ€ ${VALIDATION_CONFIG.MAX_QUESTION_LENGTH}ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.\ní˜„ì¬: ${question.length}ì`);
        return;
      }

      // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
      addMessage('user', question);
      input.value = '';
      input.style.height = '50px';

      // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì¶”ê°€
      const typingId = addTypingIndicator();

      try {
        console.log('ë©”ì‹œì§€ ì „ì†¡:', question);

        // â­ 1ë‹¨ê³„: RAGì—ì„œ ê´€ë ¨ ë¬¸ì„œ ê²€ìƒ‰
        let ragContext = '';
        let ragSources = [];
        let usedRAG = false;

        // ê°„ë‹¨í•œ ì§ˆë¬¸/ì¸ì‚¬ë§ í•„í„°ë§ (ë¬¸ì¥ë¶€í˜¸ ì œê±° í›„ íŒ¨í„´ ë§¤ì¹­)
        const questionClean = question.trim().replace(/[.,!?~\s]+$/g, '');
        const simplePatterns = /^(ì•ˆë…•|ì•ˆë…•í•˜ì„¸ìš”|hi|hello|ã…ã…‡|ë°˜ê°€ì›Œ|ë°˜ê°‘ìŠµë‹ˆë‹¤|ê°ì‚¬|ê°ì‚¬í•©ë‹ˆë‹¤|ê³ ë§ˆì›Œ|ê³ ë§™ìŠµë‹ˆë‹¤|ã„±ã……|ã„³|bye|ì˜ê°€|ë|ã…‚ã…‡)$/i;
        const shouldUseRAG = USE_RAG && questionClean.length > 5 && !simplePatterns.test(questionClean);

        if (shouldUseRAG) {
          try {
            console.log('=== RAG API í˜¸ì¶œ ì‹œì‘ ===');
            console.log('ì§ˆë¬¸:', question);

            const ragResponse = await fetchRAGWithRetry(`${RAG_API_URL}/chat`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                query: question,
                top_k: 5  // 3 â†’ 5ë¡œ ì¦ê°€í•˜ì—¬ ë” ë‹¤ì–‘í•œ ë¬¸ì„œ ê²€ìƒ‰
              })
            });

            if (ragResponse.ok) {
              const ragData = await ragResponse.json();
              console.log('=== RAG ì‘ë‹µ ë°ì´í„° ===');
              console.log('context ê¸¸ì´:', ragData.context?.length || 0);
              console.log('raw sources:', ragData.sources);

              ragContext = ragData.context || '';

              // ì¶œì²˜ ì •ê·œí™” ë° ì¤‘ë³µ ì œê±°
              const rawSources = ragData.sources || [];
              const seenFilenames = new Set(); // ì¤‘ë³µ ì²´í¬ìš©

              ragSources = rawSources
                .map(source => {
                  // ì´ë¯¸ ì •ê·œí™”ëœ ê°ì²´ì¸ ê²½ìš°
                  if (typeof source === 'object' && source !== null && source.filename) {
                    return {
                      filename: source.filename,
                      category: source.category || 'RAG',
                      source: 'rag-api'
                    };
                  }
                  // ë¬¸ìì—´ì´ê±°ë‚˜ ê¸°íƒ€ í˜•ì‹ì¸ ê²½ìš°
                  const filename = typeof source === 'string'
                    ? source
                    : (source?.source || source?.name || source?.filename || String(source));

                  return {
                    filename: filename,
                    category: 'RAG',
                    source: 'rag-api'
                  };
                })
                .filter(source => {
                  // ì¤‘ë³µ ë¬¸ì„œ ì œê±°
                  if (seenFilenames.has(source.filename)) {
                    console.log('ì¤‘ë³µ ë¬¸ì„œ ì œê±°:', source.filename);
                    return false;
                  }
                  seenFilenames.add(source.filename);
                  return true;
                });

              usedRAG = ragSources.length > 0 && ragContext.length > 50;

              console.log('=== RAG ê²€ìƒ‰ ê²°ê³¼ ===');
              console.log('ìœ íš¨í•œ ë¬¸ì„œ ìˆ˜:', ragSources.length);
              console.log('ë¬¸ì„œ ëª©ë¡:', ragSources.map(s => s.filename));
              console.log('context ë¯¸ë¦¬ë³´ê¸°:', ragContext.substring(0, 200) + '...');

              if (ragSources.length === 1) {
                console.warn('âš ï¸ ê²½ê³ : ë¬¸ì„œê°€ 1ê°œë§Œ ê²€ìƒ‰ë¨. RAG API vector search í™•ì¸ í•„ìš”');
              }

              // â­ RAG ì»¨í…ìŠ¤íŠ¸ ê´€ë ¨ì„± ê²€ì‚¬
              if (usedRAG) {
                const questionKeywords = extractKeywordsFromQuestion(question);
                const contextLower = ragContext.toLowerCase();
                const relevantKeywordCount = questionKeywords.filter(kw =>
                  contextLower.includes(kw.toLowerCase())
                ).length;

                console.log('=== RAG ê´€ë ¨ì„± ê²€ì‚¬ ===');
                console.log('ì§ˆë¬¸ í‚¤ì›Œë“œ:', questionKeywords);
                console.log('ê´€ë ¨ í‚¤ì›Œë“œ ìˆ˜:', relevantKeywordCount, '/', questionKeywords.length);

                // í‚¤ì›Œë“œ ë§¤ì¹­ì´ 50% ë¯¸ë§Œì´ë©´ RAG ê²°ê³¼ë¥¼ ì‹ ë¢°í•˜ì§€ ì•ŠìŒ
                if (questionKeywords.length > 0 && relevantKeywordCount < questionKeywords.length * 0.3) {
                  console.warn('âš ï¸ RAG ì»¨í…ìŠ¤íŠ¸ê°€ ì§ˆë¬¸ê³¼ ê´€ë ¨ì„±ì´ ë‚®ìŒ. RAG ê±´ë„ˆëœ€');
                  usedRAG = false;
                  ragContext = '';
                  ragSources = [];
                }
              }
            } else {
              console.warn('RAG API ì˜¤ë¥˜:', ragResponse.status);
            }
          } catch (ragError) {
            console.warn('RAG ê²€ìƒ‰ ì‹¤íŒ¨ (ì¼ë°˜ ëª¨ë“œë¡œ ì§„í–‰):', ragError.message);
          }
        } else {
          console.log('ê°„ë‹¨í•œ ì§ˆë¬¸ - RAG ê±´ë„ˆëœ€');
        }

        // â­ 2ë‹¨ê³„: Apps Scriptì— ì „ë‹¬í•  ì§ˆë¬¸ êµ¬ì„±
        let finalQuestion = question;

        if (ragContext) {
          finalQuestion = `ë‹¤ìŒ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ë‹µë³€í•´ì£¼ì„¸ìš”:\n\n${ragContext}\n\nì§ˆë¬¸: ${question}`;
          console.log('RAG ì»¨í…ìŠ¤íŠ¸ í¬í•¨:', ragContext.length, 'ì');
        }

        // â­ 3ë‹¨ê³„: Apps Script API í˜¸ì¶œ
        const formData = new URLSearchParams();
        formData.append('action', 'chat');
        formData.append('question', finalQuestion);
        formData.append('originalQuestion', question);  // ì›ë³¸ ì§ˆë¬¸ ë³„ë„ ì „ì†¡ (FAQ ì €ì¥ìš©)
        formData.append('sessionId', sessionId);
        formData.append('userRole', 'faculty');
        formData.append('useRAG', usedRAG ? 'true' : 'false');  // RAG ì‚¬ìš© ì—¬ë¶€ ì „ë‹¬

        const response = await fetchWithRetry(SCRIPT_URL, {
          method: 'POST',
          body: formData,
          mode: 'cors',
          cache: 'no-cache'
        });

        removeTypingIndicator(typingId);

        if (!response.ok) {
          throw new Error('API ì‘ë‹µ ì˜¤ë¥˜: ' + response.status);
        }

        const data = await response.json();
        console.log('ì‘ë‹µ ë°ì´í„°:', data);

        if (data.success) {
          // RAG ì¶œì²˜ë¥¼ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ Apps Script ì¶œì²˜ ì‚¬ìš©
          const sources = usedRAG ? ragSources : (data.sources || []);

          addMessage('bot', data.answer, {
            sources: sources,
            confidence: data.confidence || 0.5,
            messageId: data.messageId || generateMessageId(),
            usedRAG: usedRAG
          });
        } else if (data.filtered) {
          addMessage('bot', data.error, { isError: true });
        } else {
          throw new Error(data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        }

      } catch (error) {
        console.error('Error:', error);
        removeTypingIndicator(typingId);
        addMessage('bot', 'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n\nì˜¤ë¥˜: ' + error.message, { isError: true });
      }
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function updateCharCount() {
      const input = document.getElementById('userInput');
      const charCount = document.getElementById('charCount');
      const length = input.value.length;
      const maxLength = VALIDATION_CONFIG.MAX_QUESTION_LENGTH;

      charCount.textContent = `${length}/${maxLength}`;

      if (length > maxLength * 0.9) {
        charCount.style.color = '#ef4444';
      } else if (length > maxLength * 0.7) {
        charCount.style.color = '#f59e0b';
      } else {
        charCount.style.color = '#9ca3af';
      }
    }

    // ==================== ë©”ì‹œì§€ ì¶”ê°€ ====================
    function addMessage(sender, text, options = {}) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;

      const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

      if (sender === 'user') {
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = 'ğŸ‘¤';

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.textContent = text;

        const meta = document.createElement('div');
        meta.className = 'message-meta';
        meta.innerHTML = `<span>${time}</span>`;

        messageContent.appendChild(bubble);
        messageContent.appendChild(meta);

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);
      } else {
        let confidenceBadge = '';

        if (options.confidence) {
          if (options.confidence >= 0.8) {
            confidenceBadge = '<span class="confidence-badge confidence-high">âœ“ ì‹ ë¢°ë„ ë†’ìŒ</span>';
          } else if (options.confidence >= 0.6) {
            confidenceBadge = '<span class="confidence-badge confidence-medium">â— ì‹ ë¢°ë„ ë³´í†µ</span>';
          } else {
            confidenceBadge = '<span class="confidence-badge confidence-low">! ì‹ ë¢°ë„ ë‚®ìŒ</span>';
          }
        }

        let ragIndicatorHtml = '';
        if (options.usedRAG) {
          ragIndicatorHtml = '<span class="rag-indicator">ğŸ” RAG</span>';
        }

        let sourcesHtml = '';
        if (options.sources && options.sources.length > 0) {
          sourcesHtml = '<div class="sources"><div class="sources-title">ğŸ“š ì°¸ê³  ë¬¸ì„œ</div>';

          options.sources.forEach((source, index) => {
            // ì •ê·œí™”ëœ ê°ì²´ í˜•ì‹ìœ¼ë¡œ ì²˜ë¦¬ (filename, category, source ì†ì„±)
            const filename = source.filename || source.name || String(source);
            const category = source.category || 'ë¬¸ì„œ';

            sourcesHtml += `
              <div class="source-item">
                <span class="source-category">${category}</span>
                <span>${filename}</span>
              </div>
            `;
          });
          sourcesHtml += '</div>';
        }

        let feedbackHtml = '';
        if (!options.isError && options.messageId) {
          feedbackHtml = `
            <div class="feedback-buttons">
              <button class="feedback-btn positive" data-message-id="${options.messageId}" data-feedback="positive">
                ğŸ‘ ë„ì›€ë¨
              </button>
              <button class="feedback-btn negative" data-message-id="${options.messageId}" data-feedback="negative">
                ğŸ‘ ë„ì›€ ì•ˆë¨
              </button>
              <button class="feedback-btn escalate" data-action="escalate">
                ğŸ‘¤ ë‹´ë‹¹ì ì—°ê²°
              </button>
            </div>
          `;
        }

        messageDiv.innerHTML = `
          <div class="avatar">ğŸ¤–</div>
          <div class="message-content">
            <div class="message-bubble markdown-content">${parseMarkdown(text)}</div>
            ${sourcesHtml}
            <div class="message-meta">
              <span>${time}</span>
              ${ragIndicatorHtml}
              ${confidenceBadge}
            </div>
            ${feedbackHtml}
          </div>
        `;
      }

      chatMessages.appendChild(messageDiv);

      // í”¼ë“œë°± ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      if (!options.isError && options.messageId) {
        const positiveBtn = messageDiv.querySelector('.feedback-btn.positive');
        const negativeBtn = messageDiv.querySelector('.feedback-btn.negative');
        const escalateBtn = messageDiv.querySelector('.feedback-btn.escalate');

        if (positiveBtn) {
          positiveBtn.addEventListener('click', function(e) {
            const btn = e.currentTarget;
            showButtonFeedback(btn, 'â³ ì²˜ë¦¬ ì¤‘...', btn.innerHTML);
            giveFeedback(options.messageId, text, 'positive');
          });
        }

        if (negativeBtn) {
          negativeBtn.addEventListener('click', function(e) {
            const btn = e.currentTarget;
            showButtonFeedback(btn, 'â³ ì²˜ë¦¬ ì¤‘...', btn.innerHTML);
            giveFeedback(options.messageId, text, 'negative');
          });
        }

        if (escalateBtn) {
          escalateBtn.addEventListener('click', function(e) {
            const btn = e.currentTarget;
            showButtonFeedback(btn, 'â³ ì²˜ë¦¬ ì¤‘...', btn.innerHTML);
            requestEscalation(text);
          });
        }
      }

      // ìŠ¤í¬ë¡¤ UX ê°œì„ : ë´‡ ë‹µë³€ì€ ë©”ì‹œì§€ ì‹œì‘ì ìœ¼ë¡œ, ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” ë§¨ ì•„ë˜ë¡œ
      if (sender === 'bot') {
        // ë´‡ ë‹µë³€: ë‹µë³€ì˜ ì‹œì‘ ë¶€ë¶„ì´ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤
        // requestAnimationFrameì„ 2ë²ˆ ì‚¬ìš©í•˜ì—¬ ë Œë”ë§ ì™„ë£Œ ë³´ì¥
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            // ë©”ì‹œì§€ divì˜ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì™€ì„œ ëª…ì‹œì ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            const messageTop = messageDiv.offsetTop;
            const containerTop = chatMessages.offsetTop;
            const scrollPosition = messageTop - containerTop - 20; // 20px ì—¬ìœ  ê³µê°„

            console.log('ë´‡ ë‹µë³€ ìŠ¤í¬ë¡¤:', {
              messageTop: messageTop,
              containerTop: containerTop,
              scrollPosition: scrollPosition
            });

            // smooth scroll
            chatMessages.scrollTo({
              top: scrollPosition,
              behavior: 'smooth'
            });
          });
        });
      } else {
        // ì‚¬ìš©ì ë©”ì‹œì§€: ì¦‰ì‹œ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }

    function addTypingIndicator() {
      const chatMessages = document.getElementById('chatMessages');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message bot';
      typingDiv.id = 'typing-indicator-' + Date.now();

      typingDiv.innerHTML = `
        <div class="avatar">ğŸ¤–</div>
        <div class="message-content">
          <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      `;

      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      return typingDiv.id;
    }

    function removeTypingIndicator(id) {
      const indicator = document.getElementById(id);
      if (indicator) {
        indicator.remove();
      }
    }

    // ==================== í”¼ë“œë°± ====================
    function giveFeedback(messageId, question, feedback) {
      console.log('í”¼ë“œë°± ë²„íŠ¼ í´ë¦­:', feedback);

      pendingFeedback = { messageId, question, feedback };
      currentRating = 0;

      document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
      document.getElementById('feedbackComment').value = '';

      document.getElementById('feedbackModal').classList.add('active');
    }

    function setRating(rating) {
      currentRating = rating;
      const stars = document.querySelectorAll('.star');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.classList.add('active');
        } else {
          star.classList.remove('active');
        }
      });
    }

    async function submitFeedback() {
      if (!pendingFeedback) return;

      const comment = document.getElementById('feedbackComment').value.trim();

      if (comment.length > VALIDATION_CONFIG.MAX_COMMENT_LENGTH) {
        alert(`ì˜ê²¬ì€ ìµœëŒ€ ${VALIDATION_CONFIG.MAX_COMMENT_LENGTH}ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.\ní˜„ì¬: ${comment.length}ì`);
        return;
      }

      try {
        const formData = new URLSearchParams();
        formData.append('action', 'feedback');
        formData.append('sessionId', sessionId);
        formData.append('messageId', pendingFeedback.messageId);
        formData.append('feedback', pendingFeedback.feedback);
        formData.append('rating', currentRating);
        if (comment) formData.append('comment', comment);

        await fetchWithRetry(SCRIPT_URL, {
          method: 'POST',
          body: formData,
          mode: 'cors'
        });

        alert('í”¼ë“œë°±ì„ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ˜Š');
        closeFeedbackModal();

      } catch (error) {
        console.error('í”¼ë“œë°± ì „ì†¡ ì˜¤ë¥˜:', error);
        alert('í”¼ë“œë°± ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + error.message);
      }
    }

    function closeFeedbackModal() {
      document.getElementById('feedbackModal').classList.remove('active');
      pendingFeedback = null;
      currentRating = 0;
    }

    // ==================== ì—ìŠ¤ì»¬ë ˆì´ì…˜ ====================
    function requestEscalation(question) {
      pendingEscalation = { question };
      document.getElementById('escalationEmail').value = '';
      document.getElementById('escalationPhone').value = '';
      document.getElementById('escalationModal').classList.add('active');
    }

    async function submitEscalation() {
      if (!pendingEscalation) return;

      const email = document.getElementById('escalationEmail').value.trim();
      const phone = document.getElementById('escalationPhone').value.trim();

      if (!email) {
        alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (phone) {
        const phoneRegex = /^01[0-9]-?\d{3,4}-?\d{4}$/;
        if (!phoneRegex.test(phone)) {
          alert('ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì˜ˆ: 010-1234-5678');
          return;
        }
      }

      try {
        const formData = new URLSearchParams();
        formData.append('action', 'escalate');
        formData.append('sessionId', sessionId);
        formData.append('question', pendingEscalation.question);
        formData.append('userEmail', email);
        if (phone) formData.append('userPhone', phone);

        const response = await fetchWithRetry(SCRIPT_URL, {
          method: 'POST',
          body: formData,
          mode: 'cors'
        });

        const data = await response.json();

        if (data.success) {
          alert('ë‹´ë‹¹ì ì—°ê²° ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nê³§ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ğŸ˜Š');
          closeEscalationModal();
        } else {
          throw new Error(data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        }

      } catch (error) {
        console.error('ì—ìŠ¤ì»¬ë ˆì´ì…˜ ì˜¤ë¥˜:', error);
        alert('ìš”ì²­ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + error.message);
      }
    }

    function closeEscalationModal() {
      document.getElementById('escalationModal').classList.remove('active');
      pendingEscalation = null;
    }

    // ==================== ìœ í‹¸ë¦¬í‹° ====================
    // ì§ˆë¬¸ì—ì„œ ì£¼ìš” í‚¤ì›Œë“œ ì¶”ì¶œ (RAG ê´€ë ¨ì„± ê²€ì‚¬ìš©)
    function extractKeywordsFromQuestion(question) {
      const keywords = [];

      // êµë¬´/í•™ì‚¬ ê´€ë ¨ í‚¤ì›Œë“œ ëª©ë¡
      const domainKeywords = [
        'ì¬ì„ìš©', 'íœ´ì§', 'ì¶œì¥', 'ë³µëª…', 'ë³µëª…ì„œ', 'ìŠ¹ì§„', 'ì„ìš©', 'ì—°êµ¬ë…„',
        'ê°•ì˜', 'í•™ì ', 'ì„±ì ', 'ê·œì •', 'ì ˆì°¨', 'ì‹ ì²­', 'ì œì¶œ', 'ì‹¬ì‚¬', 'í‰ê°€',
        'ê¸°ì¤€', 'ìê²©', 'ìš”ê±´', 'ì„œë¥˜', 'ì–‘ì‹', 'êµì›', 'êµìˆ˜', 'í•™ê³¼', 'í•™ë¶€',
        'ëŒ€í•™ì›', 'í•™ê¸°', 'í•™ë…„', 'ì—°êµ¬ë¹„', 'í•™íšŒ', 'ë…¼ë¬¸', 'ê¸‰ì—¬', 'ìˆ˜ë‹¹',
        'íœ´ê°€', 'ë³‘ê°€', 'ìœ¡ì•„íœ´ì§', 'ë³´ì§', 'í•™ì¥', 'ì²˜ì¥', 'ì„ê¸°'
      ];

      // ì§ˆë¬¸ì—ì„œ ë„ë©”ì¸ í‚¤ì›Œë“œ ì¶”ì¶œ
      domainKeywords.forEach(kw => {
        if (question.includes(kw)) {
          keywords.push(kw);
        }
      });

      // ëª…ì‚¬ ì¶”ì¶œ (ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜)
      // í•œê¸€ 2ì ì´ìƒ ë‹¨ì–´ ì¤‘ ì¡°ì‚¬/ì–´ë¯¸ ì œì™¸
      const words = question.replace(/[?!.,~]/g, '').split(/\s+/);
      words.forEach(word => {
        // ì´ë¯¸ ì¶”ê°€ëœ í‚¤ì›Œë“œê°€ ì•„ë‹ˆê³ , 2ì ì´ìƒì´ë©°, ì¡°ì‚¬ê°€ ì•„ë‹Œ ê²½ìš°
        if (word.length >= 2 && !keywords.includes(word)) {
          // ê°„ë‹¨í•œ ì¡°ì‚¬ ì œê±°
          const cleanWord = word.replace(/(ì€|ëŠ”|ì´|ê°€|ì„|ë¥¼|ì—|ì˜|ìœ¼ë¡œ|ë¡œ|ì™€|ê³¼|ì—ì„œ|ê¹Œì§€|ë¶€í„°)$/g, '');
          if (cleanWord.length >= 2 && !keywords.includes(cleanWord)) {
            keywords.push(cleanWord);
          }
        }
      });

      return keywords.slice(0, 10); // ìµœëŒ€ 10ê°œ í‚¤ì›Œë“œ
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function parseMarkdown(text) {
      if (!text) return '';

      const codeBlocks = [];
      const inlineCodes = [];

      let html = text.replace(/```([\s\S]*?)```/g, function(match, code) {
        const index = codeBlocks.length;
        codeBlocks.push(escapeHtml(code.trim()));
        return `___CODEBLOCK_${index}___`;
      });

      html = html.replace(/`([^`]+)`/g, function(match, code) {
        const index = inlineCodes.length;
        inlineCodes.push(escapeHtml(code));
        return `___INLINECODE_${index}___`;
      });

      html = html.split('\n').map(line => {
        if (line.includes('___CODEBLOCK_') || line.includes('___INLINECODE_')) {
          return line;
        }
        return escapeHtml(line);
      }).join('\n');

      html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
      html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
      html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/(?<!\*)\*(?!\*)([^*]+)\*(?!\*)/g, '<em>$1</em>');
      html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, text, url) {
        if (url.match(/^https?:\/\//i)) {
          return `<a href="${url}" target="_blank" rel="noopener noreferrer">${text}</a>`;
        }
        return text;
      });

      html = html.replace(/^\d+\.\s+(.+)$/gm, '<li data-type="numbered">$1</li>');
      html = html.replace(/^[-â€¢]\s+(.+)$/gm, '<li data-type="bullet">$1</li>');

      const lines = html.split('\n');
      const result = [];
      let inList = false;
      let listType = null;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const isNumberedItem = line.includes('<li data-type="numbered">');
        const isBulletItem = line.includes('<li data-type="bullet">');

        if (isNumberedItem || isBulletItem) {
          const currentType = isNumberedItem ? 'numbered' : 'bullet';

          if (!inList) {
            result.push(currentType === 'numbered' ? '<ol>' : '<ul>');
            inList = true;
            listType = currentType;
          } else if (listType !== currentType) {
            result.push(listType === 'numbered' ? '</ol>' : '</ul>');
            result.push(currentType === 'numbered' ? '<ol>' : '<ul>');
            listType = currentType;
          }

          result.push(line.replace(' data-type="numbered"', '').replace(' data-type="bullet"', ''));

        } else {
          if (inList) {
            result.push(listType === 'numbered' ? '</ol>' : '</ul>');
            inList = false;
            listType = null;
          }
          result.push(line);
        }
      }

      if (inList) {
        result.push(listType === 'numbered' ? '</ol>' : '</ul>');
      }

      html = result.join('\n');

      html = html.replace(/___CODEBLOCK_(\d+)___/g, function(match, index) {
        return `<pre><code>${codeBlocks[index]}</code></pre>`;
      });

      html = html.replace(/___INLINECODE_(\d+)___/g, function(match, index) {
        return `<code>${inlineCodes[index]}</code>`;
      });

      html = html.replace(/\n\n+/g, '</p><p>');
      html = html.replace(/\n/g, '<br>');

      if (!html.trim().startsWith('<')) {
        html = '<p>' + html + '</p>';
      }

      html = html.replace(/<p><\/p>/g, '');
      html = html.replace(/<p>\s*<br>\s*<\/p>/g, '');

      return html;
    }

    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.classList.remove('active');
      }
    };
  </script>
</body>
</html>
